<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<!--<base href="https://openeth.com/">-->
	<title>OpenEth</title>
	<meta name="description" content="Community-driven ethical explication system.">
	<meta name="author" content="SitePoint">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>
<body>

<header>
	<nav>
		<a href="#">OpenEth</a>
		<a href="#">Featured Dilemmas</a>
		<a href="#">Play with Ethics</a>
		<a href="#">Guidance</a>
		<a href="#">Sign up</a>
	</nav>
	<div id="head_start" style="display: none;">
		<p class="one-column">OpenEth is a project designed to enable a crowd-sourced analysis of ethical
		dilemmas, to enable better decisions based upon available information, and its 
		relative likelihood.</p>
		<p><button class="button">Sign up</button></p>
	</div>
	<div id="head_dilemma" style="display: none;">
		<p class="one-column" data-content="name"></p>
	</div>
</header>

<main id="start" style="display: none;">
<article class="dilemmas">
	<section>
		<header>
			<h1>Featured dilemmas</h1>
		</header>
		<div class="dilemmas">
			<template data-array="dilemmas">
				<section class="dilemma button vertical" onclick="open_dilemma(this)">
					<input type="hidden" data-value="id">
					<header>
						<h1 data-content="name"></h1>
					</header>
					<p class="adjust" data-content="description"></p>
					<ul>
						<template data-array="features">
							<li data-content=""></li>
						</template>
					</ul>
					<footer>
						<span>CC<span>
						<span>Cases added</span>
					</footer>
				</section>
			</template>
			<button class="dilemma" onclick="add_dilemma()">
				<span class="icon">âŠ•</span>
				<span class="label">Add a dilemma</span>
			</button>
		</div>
	</section>
</article>
</main>

<main id="dilemma" style="display: none;">
	<input type="hidden" data-value="id">
	<article class="dilemma">
		<section>
			<p class="two-column" data-content="description"></p>
		</section>
		<section>
			<header>
				<h1>Actions</h1>
			</header>
			<ul>
				<template data-array="actions">
					<li data-content=""></li>
				</template>
			</ul>
		</section>
		<section>
			<header>
				<h1>Features</h1>
			</header>
			<ul>
				<template data-array="features">
					<li data-content=""></li>
				</template>
			</ul>
		</section>
		<section class="collapsable">
			<header>
				<h1>Cases</h1>
			</header>
			<div class="flex-4">
				<template data-array="cases">
					<section class="case vertical">
						<h2 data-content="name"></h2>
						<p>Author: <span data-conten="author">Homer</span></p>
						<p class="description adjust" data-content="description"></p>
						<h3>Correct Action</h3>
						<p class="action" data-content="action"></p>
					</section>
				</template>
			</div>
		</section>
		<section>
			<header>
				<h1>Key Takeaway / Duties</h1>
			</header>
			<p>It can be inferred that there are (prima facie) duties to:</p>
			<ul>
				<template data-array="duties">
					<li data-content=""></li>
				</template>
			</ul>
		</section>
		<section>
			<header>
				<h1>Rules</h1>
			</header>
			<div class="principles">
				<template data-array="principles">
					<section class="principle">
						<p>An action is ethically preferable to another if it</p>
						<ul>
							<template data-array="clauses">
								<li data-content=""></li>
							</template>
						</ul>
					</section>
				</template>
			</div>
		</section>
	</article>
</main>

<main id="case" style="display: none;">
	
</main>

<main id="not_found" style="display: none;">
	<p>Page not found!</p>
</main>

<footer>
	<p>
		Brought to you by the Dex Ethics team.
	</p>
</footer>
<script type="text/javascript" src="/script.js"></script>
<script type="text/javascript" src="/openeth.js"></script>
<script type="text/javascript">


function open_dilemma(node) {
	var id = node.getElementsByTagName('input')[0].value;
	go_to("/dilemmas/" + id);
}


// TODO: Handle request errors.
function load_state(url, callback) {
	console.log("Loading state for " + url + "...");
	if(url == '/') {
		api.get('dilemmas')
		.order('id', true)
		.range(0, 10)
		.then(callback);
	} else if(url.startsWith('/dilemmas/')) {
		api.get('dilemmas')
		.select('*,cases{*}')
		.eq('id', url.slice(10))
		.single()
		.then(callback);
	} else {
		callback({});
	}
}

function load_page(url, state) {
	console.log("Constructing page for " + url + "...", state);
	for(var el of document.querySelectorAll('main, header > div'))
		el.style.display = 'none';
	if(url == '/') {
		join('head_start', { dilemmas: state }).style.display = '';
		join('start', { dilemmas: state }).style.display = '';
	} else if(url.startsWith('/dilemmas/')) {
		solve_dilemma(state);
		var clone = JSON.parse(JSON.stringify(state));
		dilemma_map_actions(clone);
		join('head_dilemma', clone).style.display = '';
		join('dilemma', clone).style.display = '';
	} else {
		document.getElementById('not_found').style.display = '';
	}
}

function go_to(url) {
	var a = document.createElement('a');
	a.href = url;
	console.log("Loading " + a.pathname + "...");
	load_state(a.pathname, function(state) {
		console.log("Done!");
		load_page(a.pathname, state);
		window.history.pushState(state, "", a.href);
	});
}

window.addEventListener('DOMContentLoaded', function() {
	if(window.history.state === null || true) {
		console.log("Loading " + window.document.location.pathname + "...");
		load_state(window.document.location.pathname, function(state){
			console.log("Done!");
			load_page(window.document.location.pathname, window.history.state);
			window.history.replaceState(state, "", window.document.location.href);
		});
	} else {
		console.log("Using cached state...");
		load_page(window.document.location.pathname, window.history.state);
	}
});

window.addEventListener('popstate', function(event) {
	console.log("Using cached state...");
	load_page(window.document.location.pathname, event.state);
});

</script>
</body>
</html>
