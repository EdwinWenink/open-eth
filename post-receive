#!/bin/bash
set -e
source /srv/live.git/site.conf

echo "Deploying $BRANCH to $DOMAIN..."

dc="docker-compose -f docker-compose.yml -f live.yml"

if [ "$PRODUCTION" = true ] ; then
	read -p "This is a production deployment. Are you sure? [yY]" -n 1 -r
	if [[ ! $REPLY =~ ^[Yy]$ ]]
	then
		echo "Aborting deploy"
		exit 1
	fi
fi

# Update checkout
GIT_WORK_TREE=/srv/live git checkout -f $BRANCH
cd /srv/live

# Update post-receive
cp /srv/live/post-receive /srv/live.git/hooks/post-receive

# Rebuild docker
docker network create live_default || true
$dc create
$dc start

# Reload nginx
$dc kill -s SIGHUP web

# Reset permissions
sudo chown -R :adm /srv/live
sudo chmod -R g+rwX /srv/live
